<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Tonarten Analyse</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }

  .container {
    display: flex;
    gap: 20px;
  }

  textarea {
    width: 100%;
    height: 600px;
    font-family: monospace;
    font-size: 13px;
  }

  .column {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  button {
    margin: 10px 0;
    padding: 10px;
    font-size: 14px;
    cursor: pointer;
  }

  .filters {
    margin-bottom: 10px;
  }

  pre {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 10px;
    overflow-y: auto;
    height: 560px;
  }
</style>
</head>

<body>

<h2>Tonarten / Dreiklang Analyse</h2>

<div class="container">
  <!-- INPUT -->
  <div class="column">
    <h3>Input</h3>
    <textarea id="input"></textarea>
  </div>

  <!-- OUTPUT -->
  <div class="column">
    <h3>Output</h3>

    <div class="filters">
      <label><input type="radio" name="filter" value="all" checked> Alle</label>
      <label><input type="radio" name="filter" value="ok"> Nur korrekte</label>
      <label><input type="radio" name="filter" value="nok"> Nur fehlerhafte</label>
    </div>

    <button onclick="analyze()">Analysieren</button>
    <pre id="output"></pre>
  </div>
</div>

<script>
const NOTE_ORDER = [
  'c','cis','d','dis','e','f','fis','g','gis','a','ais','h'
];
const FLAT_TO_SHARP = {
  des: 'cis',
  es: 'dis',
  as: 'gis'
};

function normalizeKeyNote(note) {
  return FLAT_TO_SHARP[note] || note;
}

let results = [];

function normalizeNote(note) {
  return note
    .replace(/\([^)]*\)/g, '')   // <-- (Solo), (A1), ...
    .toLowerCase()
    .replace(/[^a-his']/g, '')
    .trim();
}

function stripOctave(note) {
  return note.replace(/'/g, '');
}

function buildTriad(key) {
  const m = key.match(/^([a-h])(is|es)?-(Dur|Moll)$/i);
  if (!m) return null;

let root = m[1].toLowerCase();
if (m[2]) root += m[2].toLowerCase();
root = normalizeKeyNote(root);
  const mode = m[3];

  const rootIndex = NOTE_ORDER.indexOf(root);
  if (rootIndex === -1) return null;

  const thirdInterval = mode === 'Dur' ? 4 : 3;
  const fifthInterval = 7;

  return [
    root,
    NOTE_ORDER[(rootIndex + thirdInterval) % 12],
    NOTE_ORDER[(rootIndex + fifthInterval) % 12]
  ];
}

function analyze() {
  const input = document.getElementById('input').value;
  const lines = input.split('\n');
  results = [];

  lines.forEach(line => {
    line = line.trim();
    if (!line.includes('/')) return; // NUR Zeilen mit /

    let title = '';
    let musicPart = '';

    if (line.includes(';')) {
      // Titel vorhanden
      const firstSemicolon = line.indexOf(';');
      title = line.slice(0, firstSemicolon).trim();
      musicPart = line.slice(firstSemicolon + 1).replace(/;+$/, '').trim();
    } else {
      // Kein Titel
      musicPart = line;
    }

    const parts = musicPart.split('/');
    if (parts.length < 2) return;

    const key = parts[0].trim();
    const triad = buildTriad(key);
    if (!triad) return;

    const notes = parts[1]
      .trim()
      .split(/\s+/)
      .map(normalizeNote)
      .filter(n => n && n !== '-');

    const ok = [];
    const nok = [];

    notes.forEach(n => {
      if (triad.includes(normalizeKeyNote(stripOctave(n)))) {
        ok.push(n);
      } else {
        nok.push(n);
      }
    });

    results.push({
      title,
      key,
      triad,
      notes,
      ok,
      nok
    });
  });

  render();
}


function render() {
  const filter = document.querySelector('input[name="filter"]:checked').value;
  const out = [];

  results.forEach(r => {
    const isOk = r.ok.length && r.nok.length === 0;
    const isNok = r.nok.length > 0;

    if (
      filter === 'ok' && !isOk ||
      filter === 'nok' && !isNok
    ) return;

let line = r.title
  ? `${r.title} â†’ ${r.key} (${r.triad.join(' ')}) / ${r.notes.join(' ')}`
  : `${r.key} (${r.triad.join(' ')}) / ${r.notes.join(' ')}`;

    if (isOk) {
      line += ' --> OK';
    } else {
      if (r.ok.length) line += ` --> OK: ${r.ok.join(' ')}`;
      if (r.nok.length) line += ` | NOK: ${r.nok.join(' ')}`;
    }

    out.push(line);
  });

  document.getElementById('output').textContent = out.join('\n');
}

// Filter sofort aktiv
document.querySelectorAll('input[name="filter"]').forEach(r =>
  r.addEventListener('change', render)
);

// Beispielinput
document.getElementById('input').value =
`A AAA Anleitung zur Bedienung des Notenarchivs;;
A Bam is ka Grasle;C-Dur / e'' c'' g' c / 3-1-5-1;
A Little Prayer;Des-Dur / f' des' as des / 3-1-5-1;
G-Dur / h' f' d' a`;
</script>

</body>
</html>
