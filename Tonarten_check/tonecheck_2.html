<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Tonarten Analyse</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }

  .container {
    display: flex;
    gap: 20px;
  }

  textarea {
    width: 100%;
    height: 600px;
    font-family: monospace;
    font-size: 13px;
  }

  .column {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  button {
    margin: 10px 0;
    padding: 10px;
    font-size: 14px;
    cursor: pointer;
  }

  .filters {
    margin-bottom: 10px;
  }

  pre {
    white-space: pre-wrap;
    background: #f5f5f5;
    padding: 10px;
    overflow-y: auto;
    height: 560px;
  }
</style>
</head>

<body>

<h2>Tonarten / Dreiklang Analyse</h2>

<div class="container">
  <!-- INPUT -->
  <div class="column">
    <h3>Input</h3>
    <textarea id="input"></textarea>
  </div>

  <!-- OUTPUT -->
  <div class="column">
    <h3>Output</h3>

    <div class="filters">
      <label><input type="radio" name="filter" value="all" checked> Alle</label>
      <label><input type="radio" name="filter" value="ok"> Nur korrekte</label>
      <label><input type="radio" name="filter" value="nok"> Nur fehlerhafte</label>
    </div>

    <button onclick="analyze()">Analysieren</button>
    <pre id="output"></pre>
  </div>
</div>

<script>
const NOTE_ORDER = [
  'c','cis','d','dis','e','f','fis','g','gis','a','b','h'
];

const FLAT_TO_SHARP = {
  des: 'cis',
  es: 'dis',
  as: 'gis'
};

// Vorzeichen pro Tonart (Dur)
const KEY_SIGNATURES = {
  "C-Dur": [],
  "G-Dur": ["fis"],
  "D-Dur": ["fis","cis"],
  "A-Dur": ["fis","cis","gis"],
  "E-Dur": ["fis","cis","gis","dis"],
  "B-Dur": ["fis","cis","gis","dis","ais"],
  "F-Dur": ["b"],
  "Es-Dur": ["b","es","as"],
  "As-Dur": ["b","es","as","des"],
  "Des-Dur": ["b","es","as","des","ges"]
};

function normalizeKeyNote(note) {
  return FLAT_TO_SHARP[note] || note;
}

let results = [];

function normalizeNote(note) {
  return note
    .replace(/\([^)]*\)/g, '')   // (Solo), (A1), etc. entfernen
    .toLowerCase()
    .replace(/[^a-his']/g, '')
    .trim();
}

function stripOctave(note) {
  return note.replace(/'/g, '');
}

function normalizeForCompare(note) {
  return normalizeKeyNote(stripOctave(normalizeNote(note)));
}

function buildTriad(key) {
  const m = key.match(/^([a-h])(is|es)?-(Dur|Moll)$/i);
  if (!m) return null;

  let root = m[1].toLowerCase();
  if (m[2]) root += m[2].toLowerCase();
  root = normalizeKeyNote(root);
  const mode = m[3];

  const rootIndex = NOTE_ORDER.indexOf(root);
  if (rootIndex === -1) return null;

  const thirdInterval = mode === 'Dur' ? 4 : 3;
  const fifthInterval = 7;

  return [
    root,
    NOTE_ORDER[(rootIndex + thirdInterval) % 12],
    NOTE_ORDER[(rootIndex + fifthInterval) % 12]
  ];
}

// alle Töne der Tonart (Dur) erzeugen
function getDiatonicNotes(key) {
  const m = key.match(/^([a-h])(is|es)?-(Dur|Moll)$/i);
  if (!m) return [];
  let root = m[1].toLowerCase();
  if (m[2]) root += m[2].toLowerCase();
  root = normalizeKeyNote(root);
  const mode = m[3];

  const sig = KEY_SIGNATURES[key] || [];
  const rootIndex = NOTE_ORDER.indexOf(root);
  if (rootIndex === -1) return [];

  const scale = [];
  // Intervallmuster abhängig vom Modus
  const intervals = mode === 'Dur' ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10]; // Moll
  for (let i=0;i<intervals.length;i++){
    let note = NOTE_ORDER[(rootIndex+intervals[i])%12];
    if (sig.includes(note)) note = normalizeKeyNote(note);
    scale.push(note);
  }
  return scale;
}


function analyze() {
  const input = document.getElementById('input').value;
  const lines = input.split('\n');
  results = [];

  lines.forEach(line => {
    line = line.trim();
    if (!line.includes('/')) return; // NUR Zeilen mit /

    let title = '';
    let musicPart = '';

    if (line.includes(';')) {
      const firstSemicolon = line.indexOf(';');
      title = line.slice(0, firstSemicolon).trim();
      musicPart = line.slice(firstSemicolon + 1).replace(/;+$/,'').trim();
    } else {
      musicPart = line;
    }

    const parts = musicPart.split('/');
    if (parts.length < 2) return;

    const key = parts[0].trim();
    const triad = buildTriad(key);
    if (!triad) return;

    const notes = parts[1].trim().split(/\s+/)
      .map(normalizeNote)
      .filter(n => n && n !== '-');

    const scaleNotes = getDiatonicNotes(key);

    const ok = [];
    const nok = [];

    notes.forEach(n => {
	  const stripped = normalizeForCompare(n);
	  if (triad.includes(stripped)) {
		ok.push(n);
	  } else {
		nok.push(n);
	  }
	});


    results.push({title,key,triad,notes,ok,nok});
  });

  render();
}

function render() {
  const filter = document.querySelector('input[name="filter"]:checked').value;
  const out = [];

  results.forEach(r => {
    const isOk = r.ok.length && r.nok.length === 0;
    const isNok = r.nok.length > 0;

    if ((filter==='ok' && !isOk) || (filter==='nok' && !isNok)) return;

    let line = r.title
      ? `${r.title} → ${r.key} (${r.triad.join(' ')}) / ${r.notes.join(' ')}`
      : `${r.key} (${r.triad.join(' ')}) / ${r.notes.join(' ')}`;

    if (isOk) {
      line += ' --> OK';
    } else {
      if (r.ok.length) line += ` --> OK: ${r.ok.join(' ')}`;
      if (r.nok.length) line += ` | NOK: ${r.nok.join(' ')}`;
    }

    out.push(line);
  });

  document.getElementById('output').textContent = out.join('\n');
}

// Filter sofort aktiv
document.querySelectorAll('input[name="filter"]').forEach(r =>
  r.addEventListener('change', render)
);

// Beispielinput
document.getElementById('input').value =
`A AAA Anleitung zur Bedienung des Notenarchivs;;
A Bam is ka Grasle;C-Dur / e'' c'' g' c / 3-1-5-1;
A Little Prayer;Des-Dur / f' des' as des / 3-1-5-1;
G-Dur / h' f' d' a;
Das Liad vom Spatn Abnd;D-Dur / a' (Solo) a a a a / 5-5-5-5;
Da Almsee is trüab;B-Dur / b' d' f' b / 1-3-5-1;
Marias Wiegenlied;G-Dur / h' c'' f' d' d / 1-2-3-4-5;`;
</script>

</body>
</html>
